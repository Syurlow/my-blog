---
/**
 * éšæœºæ–‡ç« ç»„ä»¶
 * ä¾§è¾¹æ å¡ç‰‡æ ·å¼ï¼Œç‚¹å‡»éšæœºè·³è½¬åˆ°ä¸€ç¯‡æ–‡ç« 
 */
import { getCollection } from 'astro:content';
import WidgetLayout from './widget/WidgetLayout.astro';

// è·å–æ‰€æœ‰å·²å‘å¸ƒçš„æ–‡ç« 
const posts = await getCollection('posts', ({ data }) => {
	return !data.draft;
});

// ç”Ÿæˆæ–‡ç« åˆ—è¡¨ï¼ˆåŒ…å« slug å’Œæ ‡é¢˜ï¼‰
const postList = posts.map(post => ({
	slug: post.slug,
	title: post.data.title
}));
---

<WidgetLayout name="éšæœºæ¼«æ¸¸" id="random-post-widget" style="margin-bottom: 1rem;">
	<div class="random-post-container">
		<div class="random-post-preview" id="random-post-preview">
			<span class="preview-text">ç‚¹å‡»æŒ‰é’®æ¢ç´¢éšæœºæ–‡ç«  â„ï¸</span>
		</div>
		<button id="random-post-btn" class="random-post-btn" title="éšæœºæ¼«æ¸¸ ğŸ²">
			<span class="icon">ğŸ²</span>
			<span class="text">éšæœºä¸€ç¯‡</span>
		</button>
	</div>
</WidgetLayout>

<script is:inline define:vars={{ postList }}>
	function initRandomPost() {
		const btn = document.getElementById('random-post-btn');
		const preview = document.getElementById('random-post-preview');
		if (!btn || !postList || postList.length === 0) return;

		btn.addEventListener('click', () => {
			// è·å–å½“å‰é¡µé¢çš„ slug
			const currentPath = window.location.pathname;
			const currentSlug = currentPath.split('/').filter(Boolean).pop();

			// è¿‡æ»¤æ‰å½“å‰æ–‡ç« 
			let availablePosts = postList.filter(post => post.slug !== currentSlug);
			
			// å¦‚æœåªæœ‰ä¸€ç¯‡æ–‡ç« ï¼Œå°±ç”¨åŸæ¥çš„åˆ—è¡¨
			if (availablePosts.length === 0) {
				availablePosts = postList;
			}

			// éšæœºé€‰æ‹©
			const randomPost = availablePosts[Math.floor(Math.random() * availablePosts.length)];
			
			// æ˜¾ç¤ºé¢„è§ˆ
			if (preview) {
				preview.innerHTML = `<a href="/my-blog/posts/${randomPost.slug}/" class="preview-link">${randomPost.title}</a>`;
				preview.classList.add('show-preview');
			}
			
			// æ·»åŠ åŠ¨ç”»æ•ˆæœ
			btn.classList.add('spinning');
			setTimeout(() => btn.classList.remove('spinning'), 500);
		});
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initRandomPost);
	} else {
		initRandomPost();
	}

	// Swup æ”¯æŒ
	document.addEventListener('astro:page-load', initRandomPost);
</script>

<style>
	.random-post-container {
		display: flex;
		flex-direction: column;
		gap: 12px;
		padding: 8px 0;
	}

	.random-post-preview {
		min-height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 8px 12px;
		background: var(--card-bg);
		border-radius: 8px;
		transition: all 0.3s ease;
	}

	.random-post-preview .preview-text {
		color: var(--text-secondary);
		font-size: 0.875rem;
		text-align: center;
	}

	.random-post-preview :global(.preview-link) {
		color: oklch(0.7 0.14 var(--hue, 200));
		text-decoration: none;
		font-weight: 500;
		transition: color 0.2s ease;
		text-align: center;
		display: block;
	}

	.random-post-preview :global(.preview-link:hover) {
		color: oklch(0.8 0.16 var(--hue, 200));
		text-decoration: underline;
	}

	.random-post-preview.show-preview {
		background: oklch(0.3 0.05 var(--hue, 200) / 0.2);
		border: 1px solid oklch(0.6 0.1 var(--hue, 200) / 0.3);
	}

	.random-post-btn {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 8px;
		width: 100%;
		padding: 10px 16px;
		border: none;
		background: oklch(0.5 0.12 var(--hue, 200));
		color: white;
		border-radius: 8px;
		cursor: pointer;
		font-size: 0.9rem;
		font-weight: 500;
		transition: all 0.3s ease;
	}

	.random-post-btn:hover {
		background: oklch(0.55 0.14 var(--hue, 200));
		transform: translateY(-1px);
		box-shadow: 0 4px 12px oklch(0.5 0.12 var(--hue, 200) / 0.3);
	}

	.random-post-btn:active {
		transform: translateY(0);
	}

	.random-post-btn .icon {
		font-size: 1.1rem;
		transition: transform 0.5s ease;
	}

	.random-post-btn.spinning .icon {
		animation: spin 0.5s ease-out;
	}

	@keyframes spin {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(720deg);
		}
	}
</style>