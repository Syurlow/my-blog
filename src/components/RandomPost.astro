---
/**
 * éšæœºæ–‡ç« æŒ‰é’®ç»„ä»¶
 * ç‚¹å‡»éšæœºè·³è½¬åˆ°ä¸€ç¯‡æ–‡ç« 
 */
import { getCollection } from 'astro:content';

// è·å–æ‰€æœ‰å·²å‘å¸ƒçš„æ–‡ç« 
const posts = await getCollection('posts', ({ data }) => {
	return !data.draft;
});

// ç”Ÿæˆæ–‡ç« åˆ—è¡¨ï¼ˆåªåŒ…å« slugï¼‰
const postSlugs = posts.map(post => post.slug);
---

<button id="random-post-btn" class="random-post-btn" title="éšæœºæ¼«æ¸¸ ğŸ²">
	<span class="icon">ğŸ²</span>
	<span class="text">éšæœº</span>
</button>

<script is:inline define:vars={{ postSlugs }}>
	function initRandomPost() {
		const btn = document.getElementById('random-post-btn');
		if (!btn || !postSlugs || postSlugs.length === 0) return;

		btn.addEventListener('click', () => {
			// è·å–å½“å‰é¡µé¢çš„ slug
			const currentPath = window.location.pathname;
			const currentSlug = currentPath.split('/').filter(Boolean).pop();

			// è¿‡æ»¤æ‰å½“å‰æ–‡ç« 
			let availableSlugs = postSlugs.filter(slug => slug !== currentSlug);
			
			// å¦‚æœåªæœ‰ä¸€ç¯‡æ–‡ç« ï¼Œå°±ç”¨åŸæ¥çš„åˆ—è¡¨
			if (availableSlugs.length === 0) {
				availableSlugs = postSlugs;
			}

			// éšæœºé€‰æ‹©
			const randomSlug = availableSlugs[Math.floor(Math.random() * availableSlugs.length)];
			
			// æ·»åŠ åŠ¨ç”»æ•ˆæœ
			btn.classList.add('spinning');
			
			// å»¶è¿Ÿè·³è½¬ï¼Œè®©åŠ¨ç”»æœ‰æ—¶é—´æ’­æ”¾
			setTimeout(() => {
				window.location.href = `/my-blog/posts/${randomSlug}/`;
			}, 300);
		});
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initRandomPost);
	} else {
		initRandomPost();
	}

	// Swup æ”¯æŒ
	document.addEventListener('astro:page-load', initRandomPost);
</script>

<style>
	.random-post-btn {
		display: inline-flex;
		align-items: center;
		gap: 6px;
		padding: 8px 14px;
		border: none;
		background: var(--btn-regular-bg);
		color: var(--btn-content);
		border-radius: 8px;
		cursor: pointer;
		font-size: 0.875rem;
		font-weight: 500;
		transition: all 0.3s ease;
	}

	.random-post-btn:hover {
		background: var(--btn-regular-bg-hover);
		transform: translateY(-1px);
	}

	.random-post-btn:active {
		transform: translateY(0);
	}

	.random-post-btn .icon {
		font-size: 1rem;
		transition: transform 0.3s ease;
	}

	.random-post-btn.spinning .icon {
		animation: spin 0.3s ease-out;
	}

	@keyframes spin {
		0% {
			transform: rotate(0deg);
		}
		100% {
			transform: rotate(360deg);
		}
	}

	/* ç§»åŠ¨ç«¯éšè—æ–‡å­— */
	@media (max-width: 640px) {
		.random-post-btn .text {
			display: none;
		}
		
		.random-post-btn {
			padding: 8px 10px;
		}
	}
</style>