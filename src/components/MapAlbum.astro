---
import { mapPhotos } from '../data/mapPhotos';

// 将数据序列化为 JSON，传递给客户端脚本
const photosJson = JSON.stringify(mapPhotos);
---

<!-- 地图容器 -->
<div id="map-album" style="width: 100%; height: 600px; border-radius: 12px; z-index: 1;"></div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- 将数据传递给客户端 -->
<script id="map-photos-data" type="application/json" set:html={photosJson}></script>

<script>
  function initMap() {
    const mapContainer = document.getElementById('map-album');
    if (!mapContainer) return;
    
    // 防止重复初始化
    if ((mapContainer as any)._leaflet_id) {
      return;
    }

    // 读取照片数据
    const dataScript = document.getElementById('map-photos-data');
    if (!dataScript) return;
    
    let photos: Array<{
      title: string;
      description?: string;
      imageUrl: string;
      lat: number;
      lng: number;
    }> = [];
    
    try {
      photos = JSON.parse(dataScript.textContent || '[]');
    } catch (e) {
      console.error('Failed to parse photo data:', e);
      return;
    }

    // 动态加载 Leaflet JS
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = () => {
      const L = (window as any).L;
      
      // 设置地图中心点
      const center: [number, number] = photos.length > 0 
        ? [photos[0].lat, photos[0].lng] 
        : [35.0, 105.0]; // 默认中国中心
        
      const map = L.map('map-album').setView(center, 4);

      // 添加地图图层
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      // 添加所有标记
      photos.forEach(photo => {
        const marker = L.marker([photo.lat, photo.lng]).addTo(map);
        
        const popupContent = `
          <div style="text-align: center; min-width: 180px;">
            <h3 style="font-weight: bold; font-size: 16px; margin-bottom: 8px;">${photo.title}</h3>
            <img src="${photo.imageUrl}" alt="${photo.title}" 
                 style="width: 100%; max-width: 180px; height: 100px; object-fit: cover; border-radius: 6px; margin-bottom: 8px;"
                 onerror="this.style.display='none'">
            <p style="font-size: 12px; color: #666;">${photo.description || ''}</p>
          </div>
        `;
        
        marker.bindPopup(popupContent);
      });
    };
    
    document.head.appendChild(script);
  }

  // 页面加载时初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }
  
  // 支持 Astro View Transitions
  document.addEventListener('astro:page-load', initMap);
</script>

<style>
  #map-album {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }
</style>
