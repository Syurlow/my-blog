---
import { mapPhotos } from '../data/mapPhotos';
import { flightsMeta } from '../data/flightRoutes';
import { trainsMeta } from '../data/trainRoutes';

const photosJson = JSON.stringify(mapPhotos);
const flightsMetaJson = JSON.stringify(flightsMeta);
const trainsMetaJson = JSON.stringify(trainsMeta);
---

<!-- æ§åˆ¶é¢æ¿ -->
<div class="map-controls">
  <div class="control-group">
    <label class="control-label">
      <input type="checkbox" id="show-photos" checked />
      <span class="control-icon">ğŸ“·</span>
      <span>ç…§ç‰‡</span>
    </label>
    <label class="control-label">
      <input type="checkbox" id="show-flights" checked />
      <span class="control-icon">âœˆï¸</span>
      <span>èˆ©çº¿</span>
    </label>
    <label class="control-label">
      <input type="checkbox" id="show-trains" checked />
      <span class="control-icon">ğŸš„</span>
      <span>é“„è·¯</span>
    </label>
  </div>
  <div class="stats-info" id="stats-info">
    <span id="photo-count">0 å¼ ç…§ç‰‡</span>
    <span class="divider">|</span>
    <span id="flight-count">0 æ¡èˆªçº¿</span>
    <span class="divider">|</span>
    <span id="train-count">0 æ¡é“è·¯</span>
  </div>
</div>

<!-- åœ°å›¾å®¹å™¨ -->
<div id="map-album" style="width: 100%; height: 600px; border-radius: 12px; z-index: 1;"></div>

<!-- èˆªç­ä¿¡æ¯å¼¹çª— -->
<div id="flight-info-panel" class="flight-info-panel hidden">
  <button id="close-flight-panel" class="close-btn">Ã—</button>
  <div id="flight-info-content"></div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- ç…§ç‰‡æ•°æ® -->
<script is:inline id="map-photos-data" type="application/json" set:html={photosJson}></script>
<!-- èˆªç­å…ƒæ•°æ®ï¼ˆä¸å«è½¨è¿¹ç‚¹ï¼‰ -->\n<!-- ç«è½¦å…ƒæ•°æ®ï¼ˆä¸å«è½¨è¿¹ç‚¹ï¼‰ -->
<script is:inline id="map-flights-meta" type="application/json" set:html={flightsMetaJson}></script>
<script is:inline id="map-trains-meta" type="application/json" set:html={trainsMetaJson}></script>

<script>
  // èˆªç©ºå…¬å¸ä¿¡æ¯
  const airlines: Record<string, { name: string; color: string }> = {
    'CA': { name: 'ä¸­å›½å›½é™…èˆªç©º', color: '#E31837' },
    'CZ': { name: 'ä¸­å›½å—æ–¹èˆªç©º', color: '#004B87' },
    'MU': { name: 'ä¸­å›½ä¸œæ–¹èˆªç©º', color: '#003366' },
    '3U': { name: 'å››å·èˆªç©º', color: '#FF6600' },
    'HU': { name: 'æµ·å—èˆªç©º', color: '#C41230' },
    'ZH': { name: 'æ·±åœ³èˆªç©º', color: '#00A0E9' },
    'FM': { name: 'ä¸Šæµ·èˆªç©º', color: '#E60012' },
    'SC': { name: 'å±±ä¸œèˆªç©º', color: '#0066B3' },
    'EU': { name: 'æˆéƒ½èˆªç©º', color: '#00A651' },
    'GS': { name: 'å¤©æ´¥èˆªç©º', color: '#E4002B' },
    'JD': { name: 'é¦–éƒ½èˆªç©º', color: '#FF0000' },
    'TV': { name: 'è¥¿è—èˆªç©º', color: '#B71C1C' },
    'PN': { name: 'è¥¿éƒ¨èˆªç©º', color: '#4CAF50' },
    'BK': { name: 'å¥¥å‡¯èˆªç©º', color: '#FF5722' },
    'HO': { name: 'å‰ç¥¥èˆªç©º', color: '#FF6B00' },
    '9C': { name: 'æ˜¥ç§‹èˆªç©º', color: '#00AA00' },
    'KN': { name: 'è”åˆèˆªç©º', color: '#003087' },
    'G5': { name: 'åå¤èˆªç©º', color: '#FF4500' },
    'AQ': { name: 'ä¹å…ƒèˆªç©º', color: '#FF1493' },
    'DR': { name: 'ç‘ä¸½èˆªç©º', color: '#8B0000' },
  };

  function getAirlineInfo(flightNumber: string): { name: string; color: string } {
    const prefix = flightNumber.substring(0, 2).toUpperCase();
    return airlines[prefix] || { name: 'æœªçŸ¥èˆªç©º', color: '#888888' };
  }

  // WGS84 è½¬ GCJ-02 åæ ‡è½¬æ¢å‡½æ•°ï¼ˆApple Maps åæ ‡è½¬é«˜å¾·åæ ‡ï¼‰
  function wgs84ToGcj02(lng: number, lat: number): [number, number] {
    const PI = Math.PI;
    const a = 6378245.0; // é•¿åŠè½´
    const ee = 0.00669342162296594323; // åå¿ƒç‡å¹³æ–¹

    // åˆ¤æ–­æ˜¯å¦åœ¨ä¸­å›½å¢ƒå¤–
    function outOfChina(lng: number, lat: number): boolean {
      return lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271;
    }

    function transformLat(x: number, y: number): number {
      let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
      ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
      ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
      ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
      return ret;
    }

    function transformLng(x: number, y: number): number {
      let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
      ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
      ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
      ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
      return ret;
    }

    // å¦‚æœåœ¨å›½å¤–ï¼Œä¸è½¬æ¢
    if (outOfChina(lng, lat)) {
      return [lng, lat];
    }

    let dLat = transformLat(lng - 105.0, lat - 35.0);
    let dLng = transformLng(lng - 105.0, lat - 35.0);
    const radLat = lat / 180.0 * PI;
    let magic = Math.sin(radLat);
    magic = 1 - ee * magic * magic;
    const sqrtMagic = Math.sqrt(magic);
    dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * PI);
    dLng = (dLng * 180.0) / (a / sqrtMagic * Math.cos(radLat) * PI);
    
    return [lng + dLng, lat + dLat];
  }

    // å…¨å±€å˜é‡
  let map: any = null;
  let photoMarkers: any[] = [];
  let flightLayers: any[] = [];
  let showPhotos = true;
  let showFlights = true;
  let trainLayers: any[] = [];
  let showTrains = true;

  interface Photo {
    title: string;
    description?: string;
    imageUrl: string;
    lat: number;
    lng: number;
  }

  interface FlightPoint {
    lng: number;
    lat: number;
    altitude: number;
    heading: number;
    timestamp: string;
  }

  interface Train {
    id: string;
    trainNumber: string;
    date: string;
    from: string;
    to: string;
    stations: { name: string; lat: number; lng: number; }[];
    route: [number, number][];
  }

  interface Flight {
    id: string;
    flightNumber: string;
    date: string;
    route: string;
    departure: string;
    arrival: string;
    aircraftReg: string;
    aircraftType: string;
    points: FlightPoint[];
    color: string;
  }

  
      // å¤šå›¾ç‰‡è½®æ’­äº‹ä»¶å¤„ç†
      document.addEventListener('click', e => {
        const dot = e.target.closest('.slider-dots .dot');
        if (dot) {
          const index = parseInt(dot.dataset.index);
          const slider = dot.closest('.photo-slider');
          if (slider) {
            slider.querySelectorAll('.slider-img').forEach((img, i) => {
              img.classList.toggle('active', i === index);
            });
            slider.querySelectorAll('.dot').forEach((d, i) => {
              d.classList.toggle('active', i === index);
            });
          }
        }
      });

  function initMap() {
    const mapContainer = document.getElementById('map-album');
    if (!mapContainer) return;
    
    if ((mapContainer as any)._leaflet_id) {
      return;
    }

        // è§£æç…§ç‰‡æ•°æ®
    const photosScript = document.getElementById('map-photos-data');
    const flightsMetaScript = document.getElementById('map-flights-meta');
    const trainsMetaScript = document.getElementById('map-trains-meta');
    
    let photos: Photo[] = [];
    let flightsMeta: any[] = [];
    let trainsMeta: any[] = [];
    
    try {
      photos = JSON.parse(photosScript?.textContent || '[]');
      flightsMeta = JSON.parse(flightsMetaScript?.textContent || '[]');
      trainsMeta = JSON.parse(trainsMetaScript?.textContent || '[]');
    } catch (e) {
      console.error('Failed to parse data:', e);
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    const photoCountEl = document.getElementById('photo-count');
    const flightCountEl = document.getElementById('flight-count');
    if (photoCountEl) photoCountEl.textContent = `${photos.length} å¼ ç…§ç‰‡`;
    if (flightCountEl) flightCountEl.textContent = `${flightsMeta.length} æ¡èˆªçº¿`;
    const trainCountEl = document.getElementById('train-count');
    if (trainCountEl) trainCountEl.textContent = `${trainsMeta.length} æ¡é“è·¯`;

    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = () => {
      const L = (window as any).L;
      
      // ä¸­å¿ƒç‚¹
      let center: [number, number] = [35.0, 105.0];
      if (photos.length > 0) {
        const converted = wgs84ToGcj02(photos[0].lng, photos[0].lat);
        center = [converted[1], converted[0]];
      }
        
      map = L.map('map-album').setView(center, 5);

      // ä½¿ç”¨é«˜å¾·åœ°å›¾ç“¦ç‰‡
      L.tileLayer('https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
        subdomains: ['1', '2', '3', '4'],
        attribution: '&copy; é«˜å¾·åœ°å›¾',
        maxZoom: 18
      }).addTo(map);

      // è‡ªå®šä¹‰ç…§ç‰‡æ ‡è®°å›¾æ ‡
      const photoIcon = L.divIcon({
        className: 'photo-marker',
        html: '<div class="photo-marker-inner">ğŸ“·</div>',
        iconSize: [32, 32],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
      });

      // æ·»åŠ ç…§ç‰‡æ ‡è®°
      photos.forEach(photo => {
        const [gcjLng, gcjLat] = wgs84ToGcj02(photo.lng, photo.lat);
        
        const marker = L.marker([gcjLat, gcjLng], { icon: photoIcon });
        
        // å¤„ç†å¤šå›¾ç‰‡æˆ–å•å›¾ç‰‡
        const images = photo.images || (photo.imageUrl ? [photo.imageUrl] : []);
        const imageCount = images.length;
        const uniqueId = 'photo-' + Math.random().toString(36).substr(2, 8);
        
        let imageHTML = '';
        if (imageCount === 1) {
          imageHTML = `<img src="${images[0]}" alt="${photo.title}" class="photo-single-img">`;
        } else if (imageCount > 1) {
          imageHTML = `
            <div class="photo-slider" id="${uniqueId}">
              <div class="slider-container">${images.map((img, idx) => `<img src="${img}" class="slider-img ${idx === 0 ? 'active' : ''}" data-index="${idx}">`).join('')}</div>
              <div class="slider-dots">${images.map((_, idx) => `<span class="dot ${idx === 0 ? 'active' : ''}" data-index="${idx}"></span>`).join('')}</div>
            </div>`;
        }
        
        const popupContent = `
          <div class="map-photo-popup">
            <h3 class="photo-title">${photo.title}</h3>
            ${imageHTML}
            ${photo.description ? `<p class="photo-desc">${photo.description}</p>` : ''}
          </div>
        `;
        
        marker.bindPopup(popupContent, { className: 'map-photo-popup-container', maxWidth: 280 });
        photoMarkers.push(marker);
        if (showPhotos) marker.addTo(map);
      });

                  // ç»‘å®šæ§åˆ¶äº‹ä»¶
      setupControls();

      // åŠ¨æ€åŠ è½½å®Œæ•´èˆªç­æ•°æ®
      loadFlightData().then(flights => {
        renderFlights(flights, L);
      }).catch(err => {
        console.error('Failed to load flight data:', err);
      });

      // åŠ è½½å’Œæ¸²æŸ“ç®è¶…æ•°æ®
      loadTrainData().then(trains => {
        renderTrains(trains, L);
      }).catch(err => {
        console.error('Failed to load train data:', err);
      });
    };
    
    document.head.appendChild(script);
  }

  // åŠ¨æ€åŠ è½½èˆªç­æ•°æ®
  async function loadFlightData(): Promise<Flight[]> {
    try {
      const response = await fetch('/my-blog/data/flights.json');
      if (!response.ok) throw new Error('Failed to fetch flights data');
      return await response.json();
    } catch (error) {
      console.error('Error loading flight data:', error);
      return [];
    }
  }

  // åŠ è½½ç«è½¦æ•°æ®
  async function loadTrainData(): Promise<Train[]> {
    try {
      const response = await fetch('/my-blog/data/trains.json');
      if (!response.ok) throw new Error('Failed to fetch trains data');
      return await response.json();
    } catch (error) {
      console.error('Error loading train data:', error);
      return [];
    }
  }

  // æ¸²æŸ“ç®è¶…æ•°æ®
  function renderFlights(flights: Flight[], L: any) {
    flights.forEach(flight => {
      if (!flight.points || flight.points.length < 2) return;
        
        // è½¬æ¢æ‰€æœ‰è½¨è¿¹ç‚¹åæ ‡
        const latLngs = flight.points.map(p => {
          const [gcjLng, gcjLat] = wgs84ToGcj02(p.lng, p.lat);
          return [gcjLat, gcjLng];
        });
        
        const airlineInfo = getAirlineInfo(flight.flightNumber);
        
        // åˆ›å»ºèˆªçº¿ polyline
        const polyline = L.polyline(latLngs, {
          color: flight.color || airlineInfo.color,
          weight: 3,
          opacity: 0.8,
          smoothFactor: 1,
          lineJoin: 'round'
        });
        
        // æ·»åŠ èˆªçº¿è£…é¥°ï¼ˆç®­å¤´ï¼‰
        // ç®€åŒ–ï¼šåªåœ¨èˆªçº¿ä¸Šæ·»åŠ èµ·ç‚¹å’Œç»ˆç‚¹æ ‡è®°
        const startPoint = latLngs[0];
        const endPoint = latLngs[latLngs.length - 1];
        
        // èµ·ç‚¹æ ‡è®°ï¼ˆèµ·é£ï¼‰
        const startIcon = L.divIcon({
          className: 'flight-marker start-marker',
          html: `<div class="flight-marker-inner" style="background: ${flight.color || airlineInfo.color}">ğŸ›«</div>`,
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });
        
        // ç»ˆç‚¹æ ‡è®°ï¼ˆé™è½ï¼‰
        const endIcon = L.divIcon({
          className: 'flight-marker end-marker',
          html: `<div class="flight-marker-inner" style="background: ${flight.color || airlineInfo.color}">ğŸ›¬</div>`,
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });
        
        const startMarker = L.marker(startPoint, { icon: startIcon });
        const endMarker = L.marker(endPoint, { icon: endIcon });
        
        // èˆªç­ä¿¡æ¯å¼¹çª—
        const formatDate = (dateStr: string) => {
          const parts = dateStr.split('.');
          if (parts.length === 3) {
            return `20${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥`;
          }
          return dateStr;
        };
        
        const popupContent = `
          <div class="flight-popup">
            <div class="flight-header" style="background: ${flight.color || airlineInfo.color}">
              <span class="flight-number">${flight.flightNumber}</span>
              <span class="airline-name">${airlineInfo.name}</span>
            </div>
            <div class="flight-details">
              <div class="flight-route">
                <span class="departure">${flight.departure || 'æœªçŸ¥'}</span>
                <span class="arrow">â†’</span>
                <span class="arrival">${flight.arrival || 'æœªçŸ¥'}</span>
              </div>
              <div class="flight-info-row">
                <span>ğŸ“… ${formatDate(flight.date)}</span>
              </div>
              <div class="flight-info-row">
                <span>âœˆï¸ ${flight.aircraftType || 'æœªçŸ¥æœºå‹'}</span>
                <span>ğŸ“ ${flight.aircraftReg || 'æœªçŸ¥'}</span>
              </div>
            </div>
          </div>
        `;
        
        polyline.bindPopup(popupContent, { className: 'flight-popup-container' });
        startMarker.bindPopup(popupContent, { className: 'flight-popup-container' });
        endMarker.bindPopup(popupContent, { className: 'flight-popup-container' });
        
                // åˆ›å»ºå›¾å±‚ç»„
        const flightGroup = L.layerGroup([polyline, startMarker, endMarker]);
        flightLayers.push(flightGroup);
        if (showFlights) flightGroup.addTo(map);
    });
  }

  // è·å–ç«è½¦ç±»å‹é¢œè‰²
  function getTrainColor(trainNumber: string): string {
    const prefix = trainNumber.charAt(0).toUpperCase();
    const colors: Record<string, string> = {
      'G': '#e74c3c', // é«˜é“ - çº¢è‰²
      'D': '#3498db', // åŠ¨è½§ - è“è‰²
      'C': '#9e59b6', // åŸé™… - ç´«è‰²
			'Z': '#1abc9c', // ç›´è¾¾ç‰¹å¿« - é’è‰²
      'T': '#f39c12', // ç‰¹å¿« - æ©™è‰²
      'K': '#27ae60', // å¿«é€Ÿ - ç»¿è‰²
			'S': '#9559b6', // å¸‚éƒŠ - æ·±ç´«è‰²
    };
    return colors[prefix] || '#7f8c8d';
  }

  // æ¸²æŸ“ç«è½¦æ•°æ®
  function renderTrains(trains: Train[], L: any) {
    trains.forEach(train => {
      if (!train.route || train.route.length < 2) return;
      
      // è½¬æ¢åæ ‡ - trains data format is [lng, lat]
      const latLngs = train.route.map(p => {
        const [gcjLng, gcjLat] = wgs84ToGcj02(p[0], p[1]);
        return [gcjLat, gcjLng];
      });
      
      const color = getTrainColor(train.trainNumber);
      
      // åˆ›å»ºé“è·¯çº¿
      const polyline = L.polyline(latLngs, {
        color: color,
        weight: 2.5,
        opacity: 0.8,
        smoothFactor: 1
      });
      
      // å¼¹çª—å†…å®¹
      const popupContent = `<div class="train-popup">
        <div class="train-header" style="background: ${color}">
          <span class="train-number">${train.trainNumber}</span>
        </div>
        <div class="train-details">
          <div class="train-route">
            <span>${train.from}</span>
            <span class="arrow">â†’</span>
            <span>${train.to}</span>
          </div>
          <div class="train-info-row">
            <span>ğŸ“… ${train.date}</span>
          </div>
          <div class="train-info-row">
            <span>ğŸš‰ ${train.stations?.length || 2} ä¸ªç«™ç‚¹</span>
          </div>
        </div>
      </div>`;
      
      polyline.bindPopup(popupContent, { className: 'train-popup-container' });
      
      // æ·»åŠ ç«™ç‚¹æ ‡è®°
      const stationMarkers: any[] = [];
      if (train.stations) {
        train.stations.forEach((station, idx) => {
          const [gcjLng, gcjLat] = wgs84ToGcj02(station.lng, station.lat);
          const isEndpoint = idx === 0 || idx === train.stations.length - 1;
          
          const icon = L.divIcon({
            className: 'train-station-marker',
            html: `<div style="background: ${color}; width: ${isEndpoint ? 12 : 8}px; height: ${isEndpoint ? 12 : 8}px; border-radius: 50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>`,
            iconSize: [isEndpoint ? 12 : 8, isEndpoint ? 12 : 8],
            iconAnchor: [isEndpoint ? 6 : 4, isEndpoint ? 6 : 4]
          });
          
          const marker = L.marker([gcjLat, gcjLng], { icon });
          marker.bindPopup(`<b>${station.name}</b>`);
          stationMarkers.push(marker);
        });
      }
      
      const trainGroup = L.layerGroup([polyline, ...stationMarkers]);
      trainLayers.push(trainGroup);
      if (showTrains) trainGroup.addTo(map);
    });
  }

  function setupControls() {
    const showPhotosCheckbox = document.getElementById('show-photos') as HTMLInputElement;
    const showFlightsCheckbox = document.getElementById('show-flights') as HTMLInputElement;
    const closePanel = document.getElementById('close-flight-panel');
    const infoPanel = document.getElementById('flight-info-panel');

    if (showPhotosCheckbox) {
      showPhotosCheckbox.addEventListener('change', () => {
        showPhotos = showPhotosCheckbox.checked;
        photoMarkers.forEach(marker => {
          if (showPhotos) {
            marker.addTo(map);
          } else {
            map.removeLayer(marker);
          }
        });
      });
    }

    if (showFlightsCheckbox) {
      showFlightsCheckbox.addEventListener('change', () => {
        showFlights = showFlightsCheckbox.checked;
        flightLayers.forEach(layer => {
          if (showFlights) {
            layer.addTo(map);
          } else {
            map.removeLayer(layer);
          }
        });
      });
    }

    if (closePanel && infoPanel) {
      closePanel.addEventListener('click', () => {
        infoPanel.classList.add('hidden');
      });
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMap);
  } else {
    initMap();
  }
  
  document.addEventListener('astro:page-load', initMap);
</script>

<style>
  #map-album {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  }

  /* æ§åˆ¶é¢æ¿æ ·å¼ */
  .map-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    margin-bottom: 12px;
    background: var(--card-bg, #fff);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .control-group {
    display: flex;
    gap: 16px;
  }

  .control-label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 8px;
    transition: background 0.2s;
    user-select: none;
    font-size: 14px;
    color: var(--text-color, #333);
  }

  .control-label:hover {
    background: var(--btn-hover-bg, rgba(0, 0, 0, 0.05));
  }

  .control-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: var(--primary, #3b82f6);
    cursor: pointer;
  }

  .control-icon {
    font-size: 16px;
  }

  .stats-info {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 13px;
    color: var(--text-muted, #666);
  }

  .stats-info .divider {
    opacity: 0.3;
  }

  /* ç…§ç‰‡æ ‡è®°æ ·å¼ */
  :global(.photo-marker) {
    background: transparent !important;
    border: none !important;
  }

  :global(.photo-marker-inner) {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50% 50% 50% 0;
    transform: rotate(-45deg);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    font-size: 16px;
  }

  :global(.photo-marker-inner::after) {
    content: 'ğŸ“·';
    transform: rotate(45deg);
  }

  /* èˆªç­æ ‡è®°æ ·å¼ */
  :global(.flight-marker) {
    background: transparent !important;
    border: none !important;
  }

  :global(.flight-marker-inner) {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    border: 2px solid white;
  }

  /* èˆªç­å¼¹çª—æ ·å¼ */
  :global(.flight-popup-container .leaflet-popup-content-wrapper) {
    padding: 0;
    border-radius: 12px;
    overflow: hidden;
  }

  :global(.flight-popup-container .leaflet-popup-content) {
    margin: 0;
    min-width: 200px;
  }

  :global(.flight-popup) {
    font-family: inherit;
  }

  :global(.flight-popup .flight-header) {
    padding: 12px 16px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  :global(.flight-popup .flight-number) {
    font-size: 18px;
    font-weight: bold;
  }

  :global(.flight-popup .airline-name) {
    font-size: 12px;
    opacity: 0.9;
  }

  :global(.flight-popup .flight-details) {
    padding: 12px 16px;
    background: var(--card-bg, #fff);
  }

  :global(.flight-popup .flight-route) {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 16px;
    font-weight: 500;
    margin-bottom: 12px;
    color: var(--text-color, #333);
  }

  :global(.flight-popup .flight-route .arrow) {
    color: var(--primary, #3b82f6);
  }

  :global(.flight-popup .flight-info-row) {
    display: flex;
    justify-content: space-between;
    font-size: 13px;
    color: var(--text-muted, #666);
    margin-top: 6px;
  }

  /* èˆªç­ä¿¡æ¯é¢æ¿ */
  .flight-info-panel {
    position: absolute;
    top: 80px;
    right: 20px;
    width: 300px;
    max-height: 400px;
    background: var(--card-bg, #fff);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    overflow: hidden;
  }

  .flight-info-panel.hidden {
    display: none;
  }

  .flight-info-panel .close-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    border: none;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-color, #333);
    transition: background 0.2s;
  }

  /* ç«è½¦å¼¹çª—æ ·å¼ */
  :global(.train-popup-container .leaflet-popup-content-wrapper) {
    padding: 0;
    border-radius: 12px;
    overflow: hidden;
  }

  :global(.train-popup-container .leaflet-popup-content) {
    margin: 0;
    min-width: 180px;
  }

  :global(.train-popup .train-header) {
    padding: 10px 14px;
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  :global(.train-popup .train-number) {
    font-size: 18px;
    font-weight: bold;
  }

  :global(.train-popup .train-details) {
    padding: 10px 14px;
    background: var(--card-bg, #fff);
  }

  :global(.train-popup .train-route) {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 8px;
    color: var(--text-color, #333);
  }

  :global(.train-popup .train-route .arrow) {
    color: var(--primary, #3b82f6);
  }

  :global(.train-popup .train-info-row) {
    font-size: 12px;
    color: var(--text-muted, #666);
    margin-top: 4px;
    text-align: center;
  }

  :global(.train-station-marker) {
    background: transparent !important;
    border: none !important;
  }

  .flight-info-panel .close-btn:hover {
    background: rgba(0, 0, 0, 0.2);
  }

  /* å“åº”å¼ */
  @media (max-width: 640px) {
    .map-controls {
      flex-direction: column;
      gap: 12px;
    }

    .control-group {
      width: 100%;
      justify-content: center;
    }

    .stats-info {
      width: 100%;
      justify-content: center;
    }
  }

  /* åœ°å›¾ç…•ç‰‡å¼¹å‡ºæ ·å¼ */
  :global(.map-photo-popup-container .leaflet-popup-content-wrapper) {
    padding: 0;
    border-radius: 12px;
    overflow: hidden;
  }

  :global(.map-photo-popup-container .leaflet-popup-content) {
    margin: 0;
  }

  :global(.map-photo-popup) {
    text-align: center;
    padding: 12px;
    min-width: 200px;
  }

  :global(.map-photo-popup .photo-title) {
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 10px;
    color: var(--text-color, #333);
  }

  :global(.map-photo-popup .photo-desc) {
    font-size: 12px;
    color: var(--text-muted, #666);
    margin-top: 8px;
  }

  :global(.map-photo-popup .photo-single-img) {
    width: 100%;
    max-width: 220px;
    height: 140px;
    object-fit: cover;
    border-radius: 8px;
  }

  /* å¤šå›¾ç‰‡è½®æ’­æ ·å¼ */
  :global(.map-photo-popup .photo-slider) {
    position: relative;
    width: 220px;
    height: 140px;
    margin: 0 auto;
    overflow: hidden;
    border-radius: 8px;
  }

  :global(.map-photo-popup .slider-container) {
    position: relative;
    width: 100%;
    height: 100%;
  }

  :global(.map-photo-popup .slider-img) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  :global(.map-photo-popup .slider-img.active) {
    opacity: 1;
  }

  :global(.map-photo-popup .slider-dots) {
    position: absolute;
    bottom: 6px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 6px;
  }

  :global(.map-photo-popup .slider-dots .dot) {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: background 0.3s;
  }

  :global(.map-photo-popup .slider-dots .dot.active) {
    background: #fff;
  }

  :global(.map-photo-popup .slider-dots .dot:hover) {
    background: rgba(255, 255, 255, 0.8);
  }
</style>