---
/**
 * è®¿å®¢è¶³è¿¹åœ°å›¾ç»„ä»¶
 * ä½¿ç”¨ Leaflet åœ°å›¾æ˜¾ç¤ºè®¿å®¢æ¥è‡ªå“ªäº›çœä»½
 */
---

<div id="visitor-map-widget" class="visitor-map-widget card-base">
	<div class="widget-header">
		<span class="widget-title">ğŸ—ºï¸ è®¿å®¢è¶³è¿¹</span>
		<span id="visitor-count" class="visitor-count">-- ä½è®¿å®¢</span>
	</div>
	
	<div class="map-container">
		<div id="visitor-leaflet-map" class="visitor-leaflet-map"></div>
		<!-- åœ°å›¾æºåˆ‡æ¢æŒ‰é’® -->
		<button id="visitor-map-toggle" class="visitor-map-toggle" title="åˆ‡æ¢åœ°å›¾æº">
			<span class="toggle-text">é«˜å¾·</span>
		</button>
	</div>
	
	<div id="visitor-provinces" class="visitor-provinces">
		<div class="loading">åŠ è½½ä¸­...</div>
	</div>
	
	<div class="current-visitor">
		<span id="current-location">ğŸ“ æ£€æµ‹ä¸­...</span>
		<span id="location-method" class="location-method"></span>
	</div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
	.visitor-map-widget {
		padding: 16px;
		margin-bottom: 1rem;
	}

	.widget-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 12px;
	}

	.widget-title {
		font-weight: 600;
		color: var(--text-color);
	}

	.visitor-count {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.map-container {
		position: relative;
		width: 100%;
		border-radius: 8px;
		overflow: hidden;
		margin-bottom: 12px;
	}

	.visitor-leaflet-map {
		width: 100%;
		height: 180px;
		border-radius: 8px;
		z-index: 1;
	}

	/* éšè— Leaflet æ§ä»¶ä½¿ç•Œé¢æ›´ç®€æ´ */
	:global(.visitor-leaflet-map .leaflet-control-attribution) {
		font-size: 8px;
		background: rgba(255,255,255,0.7) !important;
	}

	:global(.visitor-leaflet-map .leaflet-control-zoom) {
		display: none;
	}

	/* åœ°å›¾æºåˆ‡æ¢æŒ‰é’® */
	.visitor-map-toggle {
		position: absolute;
		bottom: 8px;
		right: 8px;
		z-index: 1000;
		display: flex;
		align-items: center;
		gap: 4px;
		padding: 4px 8px;
		background: rgba(255, 255, 255, 0.9);
		backdrop-filter: blur(6px);
		-webkit-backdrop-filter: blur(6px);
		border: none;
		border-radius: 6px;
		box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
		cursor: pointer;
		transition: all 0.2s ease;
		font-size: 11px;
		font-weight: 500;
		color: #333;
	}

	:global(.dark) .visitor-map-toggle {
		background: rgba(40, 40, 40, 0.9);
		color: #fff;
	}

	.visitor-map-toggle:hover {
		transform: scale(1.05);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
	}

	/* çœä»½æ ‡è®°æ ·å¼ */
	:global(.province-marker) {
		background: transparent !important;
		border: none !important;
	}

	:global(.province-marker-inner) {
		min-width: 24px;
		padding: 2px 6px;
		background: oklch(0.55 0.15 200);
		color: white;
		font-size: 10px;
		font-weight: 600;
		border-radius: 10px;
		text-align: center;
		box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
		white-space: nowrap;
	}

	:global(.province-marker-inner.current) {
		background: oklch(0.5 0.18 200);
		animation: pulse-marker 2s infinite;
	}

	@keyframes pulse-marker {
		0%, 100% { transform: scale(1); }
		50% { transform: scale(1.1); }
	}

	.visitor-provinces {
		max-height: 60px;
		overflow-y: auto;
		margin-bottom: 8px;
	}

	.visitor-provinces .loading {
		text-align: center;
		color: var(--text-muted);
		font-size: 0.75rem;
		padding: 8px;
	}

	.province-list {
		display: flex;
		flex-wrap: wrap;
		gap: 6px;
	}

	.province-tag {
		padding: 2px 8px;
		background: var(--btn-regular-bg);
		border-radius: 10px;
		font-size: 0.7rem;
		color: var(--text-muted);
	}

	.province-tag .count {
		margin-left: 4px;
		color: oklch(0.6 0.12 var(--hue, 200));
		font-weight: 600;
	}

	.current-visitor {
		text-align: center;
		padding-top: 8px;
		border-top: 1px dashed var(--line-divider);
	}

	#current-location {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.location-method {
		display: block;
		font-size: 0.65rem;
		color: var(--text-muted);
		opacity: 0.7;
		margin-top: 2px;
	}

	.location-method.gps {
		color: oklch(0.6 0.15 150); /* ç»¿è‰²è¡¨ç¤ºç²¾å‡†å®šä½ */
	}

	.location-method.ip {
		color: oklch(0.6 0.12 60); /* æ©™è‰²è¡¨ç¤ºIPå®šä½ */
	}
</style>

<script>
	import { supabase, getVisitorLocation } from '../../utils/supabase';

	// çœä»½ä¸­å¿ƒåæ ‡ï¼ˆWGS-84åæ ‡ç³»ï¼Œé€šç”¨åŸºå‡†ï¼‰
	// é«˜å¾·åœ°å›¾éœ€è¦è½¬æ¢ä¸º GCJ-02ï¼ŒOSM ç›´æ¥ä½¿ç”¨
	const provinceCoords: Record<string, [number, number]> = {
		// WGS-84 åæ ‡
		'åŒ—äº¬': [39.9042, 116.4074],
		'å¤©æ´¥': [39.1252, 117.1909],
		'æ²³åŒ—': [38.0455, 114.5024],
		'å±±è¥¿': [37.8706, 112.5489],
		'å†…è’™å¤': [40.8183, 111.7652],
		'è¾½å®': [41.8057, 123.4315],
		'å‰æ—': [43.8868, 125.3245],
		'é»‘é¾™æ±Ÿ': [45.7576, 126.6424],
		'ä¸Šæµ·': [31.2304, 121.4737],
		'æ±Ÿè‹': [32.0603, 118.7969],
		'æµ™æ±Ÿ': [30.2741, 120.1551],
		'å®‰å¾½': [31.8612, 117.2830],
		'ç¦å»º': [26.0745, 119.2965],
		'æ±Ÿè¥¿': [28.6820, 115.8579],
		'å±±ä¸œ': [36.6683, 116.9972],
		'æ²³å—': [34.7657, 113.7536],
		'æ¹–åŒ—': [30.5844, 114.2986],
		'æ¹–å—': [28.2278, 112.9388],
		'å¹¿ä¸œ': [23.1317, 113.2663],
		'å¹¿è¥¿': [22.8155, 108.3275],
		'æµ·å—': [20.0200, 110.3486],
		'é‡åº†': [29.5630, 106.5516],
		'å››å·': [30.6599, 104.0657],
		'è´µå·': [26.5982, 106.7073],
		'äº‘å—': [25.0453, 102.7097],
		'è¥¿è—': [29.6500, 91.1409],
		'é™•è¥¿': [34.2658, 108.9541],
		'ç”˜è‚ƒ': [36.0594, 103.8260],
		'é’æµ·': [36.6232, 101.7804],
		'å®å¤': [38.4717, 106.2587],
		'æ–°ç–†': [43.7931, 87.6271],
		'é¦™æ¸¯': [22.3193, 114.1694],
		'æ¾³é—¨': [22.1987, 113.5439],
		'å°æ¹¾': [25.0330, 121.5654],
	};

	// WGS-84 è½¬ GCJ-02 åæ ‡è½¬æ¢ï¼ˆç”¨äºé«˜å¾·åœ°å›¾ï¼‰
	function wgs84ToGcj02(lng: number, lat: number): [number, number] {
		const PI = Math.PI;
		const a = 6378245.0;
		const ee = 0.00669342162296594323;

		function outOfChina(lng: number, lat: number): boolean {
			return lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271;
		}

		function transformLat(x: number, y: number): number {
			let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
			ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
			ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
			ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
			return ret;
		}

		function transformLng(x: number, y: number): number {
			let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
			ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
			ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
			ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
			return ret;
		}

		if (outOfChina(lng, lat)) {
			return [lng, lat];
		}

		let dLat = transformLat(lng - 105.0, lat - 35.0);
		let dLng = transformLng(lng - 105.0, lat - 35.0);
		const radLat = lat / 180.0 * PI;
		let magic = Math.sin(radLat);
		magic = 1 - ee * magic * magic;
		const sqrtMagic = Math.sqrt(magic);
		dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * PI);
		dLng = (dLng * 180.0) / (a / sqrtMagic * Math.cos(radLat) * PI);
		
		return [lng + dLng, lat + dLat];
	}

	interface VisitorStats {
		province: string;
		count: number;
	}

	class VisitorMapManager {
		private map: any = null;
		private L: any = null;
		private currentTileLayer: any = null;
		private currentMapSource: 'amap' | 'osm' = 'amap';
		private provinceMarkers: any[] = [];
		private currentProvince: string | null = null;
		private visitedProvinces: Map<string, number> = new Map();

		constructor() {
			this.init();
		}

		private async init() {
			// å…ˆåŠ è½½åœ°å›¾
			await this.loadLeaflet();
			
			// ç„¶åå¼‚æ­¥åŠ è½½æ•°æ®
			try {
				await this.recordVisitor();
				await this.loadStats();
				// æ•°æ®åŠ è½½å®Œæˆåæ·»åŠ æ ‡è®°
				this.renderProvinceMarkers();
			} catch (err) {
				console.warn('è®¿å®¢æ•°æ®åŠ è½½å¤±è´¥:', err);
			}
		}

		private async loadLeaflet() {
			return new Promise<void>((resolve) => {
				if ((window as any).L) {
					this.L = (window as any).L;
					this.initMap();
					resolve();
					return;
				}

				const script = document.createElement('script');
				script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
				script.onload = () => {
					this.L = (window as any).L;
					this.initMap();
					resolve();
				};
				document.head.appendChild(script);
			});
		}

		private initMap() {
			const container = document.getElementById('visitor-leaflet-map');
			if (!container || (container as any)._leaflet_id) return;

			// ä¸­å›½ä¸­å¿ƒ
			this.map = this.L.map('visitor-leaflet-map', {
				zoomControl: false,
				attributionControl: true,
				dragging: true,
				scrollWheelZoom: false,
			}).setView([35.0, 105.0], 3);

			// æ£€æŸ¥ä¿å­˜çš„åå¥½æˆ–é»˜è®¤ä½¿ç”¨é«˜å¾·
			const savedSource = localStorage.getItem('preferred-map-source') as 'amap' | 'osm' | null;
			this.switchMapSource(savedSource || 'amap');

			// ç»‘å®šåˆ‡æ¢æŒ‰é’®
			const toggleBtn = document.getElementById('visitor-map-toggle');
			if (toggleBtn) {
				toggleBtn.addEventListener('click', () => {
					const newSource = this.currentMapSource === 'amap' ? 'osm' : 'amap';
					this.switchMapSource(newSource);
				});
			}
		}

		private switchMapSource(source: 'amap' | 'osm') {
			if (!this.map) return;

			if (this.currentTileLayer) {
				this.map.removeLayer(this.currentTileLayer);
			}

			const sources = {
				amap: {
					url: 'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',
					options: { subdomains: ['1', '2', '3', '4'], maxZoom: 18 },
					name: 'é«˜å¾·'
				},
				osm: {
					url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
					options: { subdomains: ['a', 'b', 'c'], maxZoom: 19 },
					name: 'OSM'
				}
			};

			const config = sources[source];
			this.currentTileLayer = this.L.tileLayer(config.url, config.options).addTo(this.map);
			this.currentMapSource = source;

			// æ›´æ–°æŒ‰é’®
			const toggleBtn = document.getElementById('visitor-map-toggle');
			if (toggleBtn) {
				const textSpan = toggleBtn.querySelector('.toggle-text');
				if (textSpan) textSpan.textContent = config.name;
			}

			// ä¿å­˜åå¥½
			localStorage.setItem('preferred-map-source', source);

			// åˆ‡æ¢åœ°å›¾æºåé‡æ–°æ¸²æŸ“æ ‡è®°ï¼ˆä½¿ç”¨æ­£ç¡®çš„åæ ‡ç³»ï¼‰
			this.renderProvinceMarkers();
		}

		// æ ¹æ®å½“å‰åœ°å›¾æºè·å–æ­£ç¡®çš„åæ ‡
		private getCoords(province: string): [number, number] | null {
			const wgsCoords = provinceCoords[province];
			if (!wgsCoords) return null;

			if (this.currentMapSource === 'amap') {
				// é«˜å¾·éœ€è¦ GCJ-02 åæ ‡
				const [gcjLng, gcjLat] = wgs84ToGcj02(wgsCoords[1], wgsCoords[0]);
				return [gcjLat, gcjLng];
			} else {
				// OSM ä½¿ç”¨ WGS-84
				return wgsCoords;
			}
		}

		private renderProvinceMarkers() {
			if (!this.map || !this.L) return;

			// æ¸…é™¤æ—§æ ‡è®°
			this.provinceMarkers.forEach(m => this.map.removeLayer(m));
			this.provinceMarkers = [];

			// æ·»åŠ æœ‰è®¿å®¢çš„çœä»½æ ‡è®°
			this.visitedProvinces.forEach((count, province) => {
				const coords = this.getCoords(province);
				if (!coords) return;

				const isCurrent = province === this.currentProvince;
				const icon = this.L.divIcon({
					className: 'province-marker',
					html: `<div class="province-marker-inner ${isCurrent ? 'current' : ''}">${province.slice(0, 2)} ${count}</div>`,
					iconSize: [50, 20],
					iconAnchor: [25, 10]
				});

				const marker = this.L.marker(coords, { icon });
				marker.bindPopup(`<b>${province}</b><br/>è®¿å®¢: ${count} äºº`);
				marker.addTo(this.map);
				this.provinceMarkers.push(marker);
			});

			// å¦‚æœå½“å‰çœä»½æ²¡æœ‰åœ¨ç»Ÿè®¡ä¸­ï¼Œå•ç‹¬æ·»åŠ 
			if (this.currentProvince && !this.visitedProvinces.has(this.currentProvince)) {
				const coords = this.getCoords(this.currentProvince);
				if (coords) {
					const icon = this.L.divIcon({
						className: 'province-marker',
						html: `<div class="province-marker-inner current">${this.currentProvince.slice(0, 2)} 1</div>`,
						iconSize: [50, 20],
						iconAnchor: [25, 10]
					});
					const marker = this.L.marker(coords, { icon });
					marker.bindPopup(`<b>${this.currentProvince}</b><br/>ä½ åœ¨è¿™é‡Œ!`);
					marker.addTo(this.map);
					this.provinceMarkers.push(marker);
				}
			}
		}

		private async recordVisitor() {
			try {
				const location = await getVisitorLocation();
				if (!location) return;

				this.currentProvince = location.province;
				
				// æ›´æ–°å½“å‰ä½ç½®æ˜¾ç¤º
				const locEl = document.getElementById('current-location');
				const methodEl = document.getElementById('location-method');
				
				if (locEl) {
					locEl.textContent = `ğŸ“ ä½ æ¥è‡ª ${location.province}${location.city ? ' Â· ' + location.city : ''}`;
				}
				
				if (methodEl && location.method) {
					if (location.method === 'gps') {
						methodEl.textContent = 'ğŸ›°ï¸ GPSå®šä½';
						methodEl.className = 'location-method gps';
					} else {
						methodEl.textContent = 'ğŸŒ IPå®šä½';
						methodEl.className = 'location-method ip';
					}
				}

				// è®°å½•åˆ° Supabase
				const visitorId = this.getVisitorId();
				await supabase.insert('visitors', {
					visitor_id: visitorId,
					province: location.province,
					city: location.city,
					country: location.country,
				});

			} catch (err) {
				console.warn('è®°å½•è®¿å®¢å¤±è´¥:', err);
				const locEl = document.getElementById('current-location');
				if (locEl) locEl.textContent = 'ğŸ“ æœªçŸ¥ä½ç½®';
			}
		}

		private getVisitorId(): string {
			let id = localStorage.getItem('visitor_id');
			if (!id) {
				id = 'v_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
				localStorage.setItem('visitor_id', id);
			}
			return id;
		}

		private async loadStats() {
			try {
				// è°ƒç”¨ Supabase RPC è·å–ç»Ÿè®¡
				const stats = await supabase.rpc('get_visitor_stats');
				
				if (stats && Array.isArray(stats)) {
					this.renderStats(stats);
				}
			} catch (err) {
				console.warn('åŠ è½½è®¿å®¢ç»Ÿè®¡å¤±è´¥:', err);
				// æ˜¾ç¤ºç©ºçŠ¶æ€
				const container = document.getElementById('visitor-provinces');
				if (container) {
					container.innerHTML = '<div class="province-list"><span class="province-tag">æš‚æ— æ•°æ®</span></div>';
				}
			}
		}

		private renderStats(stats: VisitorStats[]) {
			stats.forEach(stat => {
				this.visitedProvinces.set(stat.province, stat.count);
			});

			const totalCount = stats.reduce((sum, s) => sum + s.count, 0);
			const countEl = document.getElementById('visitor-count');
			if (countEl) countEl.textContent = `${totalCount} ä½è®¿å®¢`;

			const container = document.getElementById('visitor-provinces');
			if (container) {
				const sortedStats = stats.sort((a, b) => b.count - a.count).slice(0, 6);
				container.innerHTML = `
					<div class="province-list">
						${sortedStats.map(s => `
							<span class="province-tag">
								${s.province}<span class="count">${s.count}</span>
							</span>
						`).join('')}
					</div>
				`;
			}
		}
	}

	// åˆå§‹åŒ–
	function initVisitorMap() {
		const widget = document.getElementById('visitor-map-widget');
		if (!widget || (widget as any)._initialized) return;
		(widget as any)._initialized = true;
		new VisitorMapManager();
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initVisitorMap);
	} else {
		setTimeout(initVisitorMap, 1000);
	}

	document.addEventListener('astro:page-load', () => {
		setTimeout(initVisitorMap, 1000);
	});
</script>