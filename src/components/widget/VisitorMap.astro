---
/**
 * è®¿å®¢è¶³è¿¹åœ°å›¾ç»„ä»¶
 * æ˜¾ç¤ºè®¿å®¢æ¥è‡ªå“ªäº›çœä»½ï¼ˆä¸­å›½åœ°å›¾çƒ­åŠ›å›¾ï¼‰
 */
---

<div id="visitor-map-widget" class="visitor-map-widget card-base">
	<div class="widget-header">
		<span class="widget-title">ğŸ—ºï¸ è®¿å®¢è¶³è¿¹</span>
		<span id="visitor-count" class="visitor-count">-- ä½è®¿å®¢</span>
	</div>
	
	<div class="map-container">
		<div id="china-map" class="china-map-grid"></div>
	</div>
	
	<div id="visitor-provinces" class="visitor-provinces">
		<div class="loading">åŠ è½½ä¸­...</div>
	</div>
	
	<div class="current-visitor">
		<span id="current-location">ğŸ“ æ£€æµ‹ä¸­...</span>
		<span id="location-method" class="location-method"></span>
	</div>
</div>

<style>
	.visitor-map-widget {
		padding: 16px;
		margin-bottom: 1rem;
	}

	.widget-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 12px;
	}

	.widget-title {
		font-weight: 600;
		color: var(--text-color);
	}

	.visitor-count {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.map-container {
		width: 100%;
		padding: 8px;
		background: var(--card-bg);
		border-radius: 8px;
		margin-bottom: 12px;
	}

	.china-map-grid {
		display: grid;
		grid-template-columns: repeat(7, 1fr);
		gap: 3px;
	}

	:global(.province-cell) {
		aspect-ratio: 1;
		border-radius: 4px;
		background: rgba(200, 200, 200, 0.3);
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 0.5rem;
		color: var(--text-muted);
		transition: all 0.3s ease;
		cursor: default;
		position: relative;
	}

	:global(.province-cell.visited) {
		background: oklch(0.75 0.12 200);
		color: white;
	}

	:global(.province-cell.current) {
		background: oklch(0.65 0.15 200);
		color: white;
		box-shadow: 0 0 8px oklch(0.7 0.15 200 / 0.5);
		animation: pulse-cell 2s infinite;
	}

	:global(.province-cell:hover) {
		transform: scale(1.05);
	}

	:global(.province-cell .province-name) {
		font-size: 0.55rem;
		text-align: center;
		line-height: 1.1;
		word-break: break-all;
	}

	:global(.province-cell .visit-count) {
		position: absolute;
		top: 2px;
		right: 2px;
		font-size: 0.45rem;
		background: rgba(0,0,0,0.3);
		padding: 1px 3px;
		border-radius: 3px;
	}

	@keyframes pulse-cell {
		0%, 100% { opacity: 1; }
		50% { opacity: 0.7; }
	}

	.visitor-provinces {
		max-height: 80px;
		overflow-y: auto;
		margin-bottom: 8px;
	}

	.visitor-provinces .loading {
		text-align: center;
		color: var(--text-muted);
		font-size: 0.75rem;
		padding: 8px;
	}

	.province-list {
		display: flex;
		flex-wrap: wrap;
		gap: 6px;
	}

	.province-tag {
		padding: 2px 8px;
		background: var(--btn-regular-bg);
		border-radius: 10px;
		font-size: 0.7rem;
		color: var(--text-muted);
	}

	.province-tag .count {
		margin-left: 4px;
		color: oklch(0.6 0.12 var(--hue, 200));
		font-weight: 600;
	}

	.current-visitor {
		text-align: center;
		padding-top: 8px;
		border-top: 1px dashed var(--line-divider);
	}

	#current-location {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.location-method {
		display: block;
		font-size: 0.65rem;
		color: var(--text-muted);
		opacity: 0.7;
		margin-top: 2px;
	}

	.location-method.gps {
		color: oklch(0.6 0.15 150); /* ç»¿è‰²è¡¨ç¤ºç²¾å‡†å®šä½ */
	}

	.location-method.ip {
		color: oklch(0.6 0.12 60); /* æ©™è‰²è¡¨ç¤ºIPå®šä½ */
	}
</style>

<script>
	import { supabase, getVisitorLocation } from '../../utils/supabase';

	// ä¸­å›½çœä»½åˆ—è¡¨ï¼ˆæŒ‰åœ°ç†ä½ç½®æ’åºï¼Œæ–¹ä¾¿ç½‘æ ¼æ˜¾ç¤ºï¼‰
	const provinces = [
		'æ–°ç–†', 'å†…è’™å¤', 'é»‘é¾™æ±Ÿ', 'å‰æ—', 'è¾½å®', 'åŒ—äº¬', 'å¤©æ´¥',
		'è¥¿è—', 'é’æµ·', 'ç”˜è‚ƒ', 'å®å¤', 'å±±è¥¿', 'æ²³åŒ—', 'å±±ä¸œ',
		'å››å·', 'é™•è¥¿', 'æ²³å—', 'å®‰å¾½', 'æ±Ÿè‹', 'ä¸Šæµ·', '',
		'äº‘å—', 'é‡åº†', 'æ¹–åŒ—', 'æ¹–å—', 'æ±Ÿè¥¿', 'æµ™æ±Ÿ', 'å°æ¹¾',
		'è´µå·', 'å¹¿è¥¿', 'å¹¿ä¸œ', 'ç¦å»º', 'æµ·å—', 'é¦™æ¸¯', 'æ¾³é—¨',
	];

	interface VisitorStats {
		province: string;
		count: number;
	}

	class VisitorMapManager {
		private mapContainer: HTMLElement | null;
		private currentProvince: string | null = null;
		private visitedProvinces: Map<string, number> = new Map();

		constructor() {
			this.mapContainer = document.getElementById('china-map');
			this.init();
		}

		private async init() {
			// å…ˆæ¸²æŸ“ç©ºç™½åœ°å›¾ï¼Œç¡®ä¿UIæ˜¾ç¤º
			this.renderMap();
			
			// ç„¶åå¼‚æ­¥åŠ è½½æ•°æ®
			try {
				await this.recordVisitor();
				await this.loadStats();
				// æ•°æ®åŠ è½½å®Œæˆåé‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é¢œè‰²
				this.renderMap();
			} catch (err) {
				console.warn('è®¿å®¢æ•°æ®åŠ è½½å¤±è´¥:', err);
			}
		}

		private renderMap() {
			if (!this.mapContainer) return;

			this.mapContainer.innerHTML = '';
			
			for (const province of provinces) {
				const cell = document.createElement('div');
				cell.className = 'province-cell';
				
				if (!province) {
					// ç©ºç™½æ ¼å­
					cell.style.visibility = 'hidden';
				} else {
					cell.setAttribute('data-province', province);
					cell.setAttribute('title', province);
					
					// çœä»½åç§°ï¼ˆå–å‰2ä¸ªå­—ï¼‰
					const nameSpan = document.createElement('span');
					nameSpan.className = 'province-name';
					nameSpan.textContent = province.slice(0, 2);
					cell.appendChild(nameSpan);
					
					// æ£€æŸ¥æ˜¯å¦æœ‰è®¿å®¢
					const count = this.visitedProvinces.get(province) || 0;
					if (count > 0) {
						cell.classList.add('visited');
						const countSpan = document.createElement('span');
						countSpan.className = 'visit-count';
						countSpan.textContent = String(count);
						cell.appendChild(countSpan);
					}
					
					// æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰è®¿å®¢çš„çœä»½
					if (province === this.currentProvince) {
						cell.classList.add('current');
					}
				}
				
				this.mapContainer.appendChild(cell);
			}
		}

		private async recordVisitor() {
			try {
				const location = await getVisitorLocation();
				if (!location) return;

				this.currentProvince = location.province;
				
				// æ›´æ–°å½“å‰ä½ç½®æ˜¾ç¤º
				const locEl = document.getElementById('current-location');
				const methodEl = document.getElementById('location-method');
				
				if (locEl) {
					locEl.textContent = `ğŸ“ ä½ æ¥è‡ª ${location.province}${location.city ? ' Â· ' + location.city : ''}`;
				}
				
				// æ˜¾ç¤ºå®šä½æ–¹å¼
				if (methodEl && location.method) {
					if (location.method === 'gps') {
						methodEl.textContent = 'ğŸ›°ï¸ GPSå®šä½';
						methodEl.className = 'location-method gps';
					} else {
						methodEl.textContent = 'ğŸŒ IPå®šä½';
						methodEl.className = 'location-method ip';
					}
				}

				

				// è®°å½•åˆ° Supabase
				const visitorId = this.getVisitorId();
				await supabase.insert('visitors', {
					visitor_id: visitorId,
					province: location.province,
					city: location.city,
					country: location.country,
				});

			} catch (err) {
				console.warn('è®°å½•è®¿å®¢å¤±è´¥:', err);
				const locEl = document.getElementById('current-location');
				if (locEl) locEl.textContent = 'ğŸ“ æœªçŸ¥ä½ç½®';
			}
		}

		private getVisitorId(): string {
			let id = localStorage.getItem('visitor_id');
			if (!id) {
				id = 'v_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
				localStorage.setItem('visitor_id', id);
			}
			return id;
		}

		private async loadStats() {
			try {
				// è°ƒç”¨ Supabase RPC è·å–ç»Ÿè®¡
				const stats = await supabase.rpc('get_visitor_stats');
				
				if (stats && Array.isArray(stats)) {
					this.renderStats(stats);
				}
			} catch (err) {
				console.warn('åŠ è½½è®¿å®¢ç»Ÿè®¡å¤±è´¥:', err);
				// æ˜¾ç¤ºç©ºçŠ¶æ€
				const container = document.getElementById('visitor-provinces');
				if (container) {
					container.innerHTML = '<div class="province-list"><span class="province-tag">æš‚æ— æ•°æ®</span></div>';
				}
			}
		}

		private renderStats(stats: VisitorStats[]) {
			// ä¿å­˜è®¿å®¢ç»Ÿè®¡æ•°æ®
			stats.forEach(stat => {
				this.visitedProvinces.set(stat.province, stat.count);
			});

			// æ›´æ–°æ€»è®¿å®¢æ•°
			const totalCount = stats.reduce((sum, s) => sum + s.count, 0);
			const countEl = document.getElementById('visitor-count');
			if (countEl) countEl.textContent = `${totalCount} ä½è®¿å®¢`;

			// æ¸²æŸ“çœä»½åˆ—è¡¨
			const container = document.getElementById('visitor-provinces');
			if (container) {
				const sortedStats = stats.sort((a, b) => b.count - a.count).slice(0, 8);
				container.innerHTML = `
					<div class="province-list">
						${sortedStats.map(s => `
							<span class="province-tag">
								${s.province}<span class="count">${s.count}</span>
							</span>
						`).join('')}
					</div>
				`;
			}
		}
	}

	// åˆå§‹åŒ–
	function initVisitorMap() {
		const widget = document.getElementById('visitor-map-widget');
		if (!widget) return;
		new VisitorMapManager();
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initVisitorMap);
	} else {
		setTimeout(initVisitorMap, 1500);
	}

	document.addEventListener('astro:page-load', () => {
		setTimeout(initVisitorMap, 1500);
	});
</script>