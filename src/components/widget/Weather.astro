---
/**
 * å¤©æ°”å°ç»„ä»¶
 * æ˜¾ç¤ºè®¿å®¢å½“å‰ä½ç½®çš„å¤©æ°”ä¿¡æ¯
 */
---

<div id="weather-widget" class="weather-widget card-base">
	<div class="weather-loading">
		<span class="loading-icon">ğŸŒ¤ï¸</span>
		<span class="loading-text">è·å–å¤©æ°”ä¸­...</span>
	</div>
	<div class="weather-content hidden">
		<div class="weather-main">
			<span id="weather-icon" class="weather-icon">â˜€ï¸</span>
			<span id="weather-temp" class="weather-temp">--Â°C</span>
		</div>
		<div class="weather-info">
			<span id="weather-desc" class="weather-desc">--</span>
			<span id="weather-location" class="weather-location">ğŸ“ --</span>
		</div>
		<div class="weather-details">
			<span id="weather-humidity" class="detail-item">ğŸ’§ --%</span>
			<span id="weather-wind" class="detail-item">ğŸŒ¬ï¸ --</span>
		</div>
	</div>
	<div class="weather-error hidden">
		<span>ğŸ˜… è·å–å¤©æ°”å¤±è´¥</span>
	</div>
</div>

<style>
	.weather-widget {
		padding: 16px;
		margin-bottom: 1rem;
	}

	.weather-loading {
		display: flex;
		align-items: center;
		gap: 8px;
		justify-content: center;
		padding: 8px 0;
	}

	.loading-icon {
		font-size: 1.5rem;
		animation: pulse 1.5s infinite;
	}

	@keyframes pulse {
		0%, 100% { opacity: 1; }
		50% { opacity: 0.5; }
	}

	.loading-text {
		color: var(--text-muted);
		font-size: 0.875rem;
	}

	.weather-content {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.weather-content.hidden,
	.weather-error.hidden {
		display: none;
	}

	.weather-main {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 12px;
	}

	.weather-icon {
		font-size: 2.5rem;
	}

	.weather-temp {
		font-size: 2rem;
		font-weight: 700;
		color: var(--text-color);
	}

	.weather-info {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 4px;
	}

	.weather-desc {
		font-size: 1rem;
		color: var(--text-color);
	}

	.weather-location {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.weather-details {
		display: flex;
		justify-content: center;
		gap: 16px;
		margin-top: 4px;
		padding-top: 8px;
		border-top: 1px dashed var(--line-divider);
	}

	.detail-item {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.weather-error {
		text-align: center;
		color: var(--text-muted);
		font-size: 0.875rem;
		padding: 8px 0;
	}
</style>

<script>
	// å¤©æ°”å›¾æ ‡æ˜ å°„
	const weatherIcons: Record<string, string> = {
		'Clear': 'â˜€ï¸',
		'Sunny': 'â˜€ï¸',
		'Partly cloudy': 'â›…',
		'Cloudy': 'â˜ï¸',
		'Overcast': 'â˜ï¸',
		'Mist': 'ğŸŒ«ï¸',
		'Fog': 'ğŸŒ«ï¸',
		'Light rain': 'ğŸŒ¦ï¸',
		'Rain': 'ğŸŒ§ï¸',
		'Heavy rain': 'ğŸŒ§ï¸',
		'Thunderstorm': 'â›ˆï¸',
		'Snow': 'ğŸŒ¨ï¸',
		'Light snow': 'ğŸŒ¨ï¸',
		'Heavy snow': 'â„ï¸',
		'Sleet': 'ğŸŒ¨ï¸',
		'default': 'ğŸŒ¤ï¸'
	};

	function getWeatherIcon(condition: string): string {
		for (const [key, icon] of Object.entries(weatherIcons)) {
			if (condition.toLowerCase().includes(key.toLowerCase())) {
				return icon;
			}
		}
		return weatherIcons['default'];
	}

	async function initWeather() {
		const widget = document.getElementById('weather-widget');
		if (!widget) return;

		const loading = widget.querySelector('.weather-loading');
		const content = widget.querySelector('.weather-content');
		const error = widget.querySelector('.weather-error');

		try {
			// è·å–ä½ç½®ä¿¡æ¯
			const locationRes = await fetch('https://ipapi.co/json/', {
				signal: AbortSignal.timeout(5000)
			});
			
			if (!locationRes.ok) throw new Error('Location failed');
			const location = await locationRes.json();

			// ä½¿ç”¨ wttr.in å…è´¹å¤©æ°” APIï¼ˆæ— éœ€ API Keyï¼‰
			const weatherRes = await fetch(
				`https://wttr.in/${location.city}?format=j1`,
				{ signal: AbortSignal.timeout(8000) }
			);

			if (!weatherRes.ok) throw new Error('Weather failed');
			const weather = await weatherRes.json();

			// è§£æå¤©æ°”æ•°æ®
			const current = weather.current_condition[0];
			const temp = current.temp_C;
			const desc = current.lang_zh?.[0]?.value || current.weatherDesc[0].value;
			const humidity = current.humidity;
			const windSpeed = current.windspeedKmph;

			// æ›´æ–° UI
			const iconEl = document.getElementById('weather-icon');
			const tempEl = document.getElementById('weather-temp');
			const descEl = document.getElementById('weather-desc');
			const locEl = document.getElementById('weather-location');
			const humidityEl = document.getElementById('weather-humidity');
			const windEl = document.getElementById('weather-wind');

			if (iconEl) iconEl.textContent = getWeatherIcon(desc);
			if (tempEl) tempEl.textContent = `${temp}Â°C`;
			if (descEl) descEl.textContent = desc;
			if (locEl) locEl.textContent = `ğŸ“ ${location.city}, ${location.region}`;
			if (humidityEl) humidityEl.textContent = `ğŸ’§ ${humidity}%`;
			if (windEl) windEl.textContent = `ğŸŒ¬ï¸ ${windSpeed}km/h`;

			// æ˜¾ç¤ºå†…å®¹
			loading?.classList.add('hidden');
			content?.classList.remove('hidden');

		} catch (err) {
			console.warn('å¤©æ°”è·å–å¤±è´¥:', err);
			loading?.classList.add('hidden');
			error?.classList.remove('hidden');
		}
	}

	// å»¶è¿ŸåŠ è½½å¤©æ°”ï¼Œé¿å…é˜»å¡é¡µé¢
	setTimeout(initWeather, 1000);

	// Swup æ”¯æŒ
	document.addEventListener('astro:page-load', () => {
		setTimeout(initWeather, 1000);
	});
</script>