---
/**
 * å¤©æ°”å°ç»„ä»¶
 * æ˜¾ç¤ºè®¿å®¢å½“å‰ä½ç½®çš„å¤©æ°”ä¿¡æ¯
 */
import WidgetLayout from './WidgetLayout.astro';
---

<WidgetLayout name="å¤©æ°”" id="weather-widget-wrapper">
<div id="weather-widget" class="weather-widget">
	<div class="weather-loading">
		<span class="loading-icon">ğŸŒ¤ï¸</span>
		<span class="loading-text">è·å–å¤©æ°”ä¸­...</span>
	</div>
	<div class="weather-content hidden">
		<div class="weather-main">
			<span id="weather-icon" class="weather-icon">â˜€ï¸</span>
			<span id="weather-temp" class="weather-temp">--Â°C</span>
		</div>
		<div class="weather-info">
			<span id="weather-desc" class="weather-desc">--</span>
			<span id="weather-location" class="weather-location">ğŸ“ --</span>
		</div>
		<div class="weather-details">
			<span id="weather-humidity" class="detail-item">ğŸ’§ --%</span>
			<span id="weather-wind" class="detail-item">ğŸŒ¬ï¸ --</span>
		</div>
	</div>
	<div class="weather-error hidden">
		<button id="weather-retry" class="weather-retry-btn">ç‚¹å‡»é‡æ–°è·å–</button>
	</div>
</div>
</WidgetLayout>

<style>
	.weather-widget {
		padding: 8px 0;
	}

	.weather-loading {
		display: flex;
		align-items: center;
		gap: 8px;
		justify-content: center;
		padding: 8px 0;
	}

	.loading-icon {
		font-size: 1.5rem;
		animation: pulse 1.5s infinite;
	}

	@keyframes pulse {
		0%, 100% { opacity: 1; }
		50% { opacity: 0.5; }
	}

	.loading-text {
		color: var(--text-muted);
		font-size: 0.875rem;
	}

	.weather-content {
		display: flex;
		flex-direction: column;
		gap: 8px;
	}

	.weather-content.hidden,
	.weather-error.hidden {
		display: none;
	}

	.weather-main {
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 12px;
	}

	.weather-icon {
		font-size: 2.5rem;
	}

	.weather-temp {
		font-size: 2rem;
		font-weight: 700;
		color: var(--text-color);
	}

	.weather-info {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 4px;
	}

	.weather-desc {
		font-size: 1rem;
		color: var(--text-color);
	}

	.weather-location {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.weather-details {
		display: flex;
		justify-content: center;
		gap: 16px;
		margin-top: 4px;
		padding-top: 8px;
		border-top: 1px dashed var(--line-divider);
	}

	.detail-item {
		font-size: 0.75rem;
		color: var(--text-muted);
	}

	.weather-error {
		text-align: center;
		padding: 12px 0;
	}

	.weather-retry-btn {
		padding: 10px 20px;
		background: oklch(0.5 0.1 var(--hue, 200));
		border: none;
		border-radius: 8px;
		color: white;
		font-size: 0.875rem;
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.weather-retry-btn:hover {
		background: oklch(0.55 0.12 var(--hue, 200));
		transform: translateY(-1px);
	}
</style>

<script>
	import { getVisitorLocation } from '../../utils/supabase';

	// å¤©æ°”å›¾æ ‡æ˜ å°„
	const weatherIcons: Record<string, string> = {
		'Clear': 'â˜€ï¸',
		'Sunny': 'â˜€ï¸',
		'æ™´': 'â˜€ï¸',
		'Partly cloudy': 'â›…',
		'å¤šäº‘': 'â›…',
		'Cloudy': 'â˜ï¸',
		'é˜´': 'â˜ï¸',
		'Overcast': 'â˜ï¸',
		'Mist': 'ğŸŒ«ï¸',
		'é›¾': 'ğŸŒ«ï¸',
		'Fog': 'ğŸŒ«ï¸',
		'Light rain': 'ğŸŒ¦ï¸',
		'å°é›¨': 'ğŸŒ¦ï¸',
		'Rain': 'ğŸŒ§ï¸',
		'ä¸­é›¨': 'ğŸŒ§ï¸',
		'Heavy rain': 'ğŸŒ§ï¸',
		'å¤§é›¨': 'ğŸŒ§ï¸',
		'æš´é›¨': 'ğŸŒ§ï¸',
		'Thunderstorm': 'â›ˆï¸',
		'é›·é˜µé›¨': 'â›ˆï¸',
		'Snow': 'ğŸŒ¨ï¸',
		'é›ª': 'ğŸŒ¨ï¸',
		'Light snow': 'ğŸŒ¨ï¸',
		'å°é›ª': 'ğŸŒ¨ï¸',
		'Heavy snow': 'â„ï¸',
		'å¤§é›ª': 'â„ï¸',
		'æš´é›ª': 'â„ï¸',
		'Sleet': 'ğŸŒ¨ï¸',
		'é›¨å¤¹é›ª': 'ğŸŒ¨ï¸',
		'default': 'ğŸŒ¤ï¸'
	};

	function getWeatherIcon(condition: string): string {
		for (const [key, icon] of Object.entries(weatherIcons)) {
			if (condition.toLowerCase().includes(key.toLowerCase())) {
				return icon;
			}
		}
		return weatherIcons['default'];
	}

	// æ£€æµ‹æ˜¯å¦ä¸ºå›½å†…ç”¨æˆ·
	function isChina(country: string): boolean {
		const chinaNames = ['china', 'ä¸­å›½', 'ä¸­åäººæ°‘å…±å’Œå›½', 'cn', 'chn'];
		return chinaNames.some(name => country.toLowerCase().includes(name.toLowerCase()));
	}

	// ä½¿ç”¨å’Œé£å¤©æ°” APIï¼ˆå›½å†…ï¼‰- å…è´¹ç‰ˆ
	async function getQWeather(city: string): Promise<any> {
		// å’Œé£å¤©æ°”å…è´¹ APIï¼ˆæ— éœ€ Key çš„å…¬å…±æ¥å£ï¼‰
		// ä½¿ç”¨ wttr.in çš„ä¸­æ–‡ç‰ˆæœ¬ä½œä¸ºæ›¿ä»£
		const response = await fetch(
			`https://wttr.in/${encodeURIComponent(city)}?format=j1&lang=zh`,
			{ signal: AbortSignal.timeout(8000) }
		);
		if (!response.ok) throw new Error('Weather API failed');
		return response.json();
	}

	// ä½¿ç”¨ wttr.inï¼ˆå›½å¤–ï¼‰
	async function getWttrWeather(city: string): Promise<any> {
		const response = await fetch(
			`https://wttr.in/${encodeURIComponent(city)}?format=j1`,
			{ signal: AbortSignal.timeout(8000) }
		);
		if (!response.ok) throw new Error('Weather API failed');
		return response.json();
	}

	// ç­‰å¾…å®šä½ç¼“å­˜å¯ç”¨ï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼‰
	async function waitForLocationCache(maxWait = 10000): Promise<any> {
		const startTime = Date.now();
		
		while (Date.now() - startTime < maxWait) {
			const cached = (window as any).__cachedLocation;
			if (cached && cached.data) {
				console.log('ğŸŒ¤ï¸ ä½¿ç”¨è®¿å®¢åœ°å›¾çš„å®šä½ç¼“å­˜');
				return cached.data;
			}
			// ç­‰å¾…500msåå†æ£€æŸ¥
			await new Promise(resolve => setTimeout(resolve, 500));
		}
		
		// è¶…æ—¶åè‡ªå·±è·å–å®šä½
		console.log('ğŸŒ¤ï¸ å®šä½ç¼“å­˜è¶…æ—¶ï¼Œè‡ªè¡Œè·å–å®šä½');
		return await getVisitorLocation();
	}

	async function initWeather() {
		const widget = document.getElementById('weather-widget');
		if (!widget) return;

		const loading = widget.querySelector('.weather-loading');
		const content = widget.querySelector('.weather-content');
		const error = widget.querySelector('.weather-error');

		try {
			// ç­‰å¾…è®¿å®¢åœ°å›¾çš„å®šä½ç»“æœï¼ˆå…±äº«å®šä½æ•°æ®ï¼‰
			const location = await waitForLocationCache();
			if (!location) throw new Error('Location failed');

			console.log('ğŸŒ¤ï¸ å¤©æ°”å®šä½:', location);

			// æ ¹æ®å›½å®¶é€‰æ‹©å¤©æ°” API
			const isChinaUser = isChina(location.country);
			const cityName = location.city || location.province;
			
			let weather;
			if (isChinaUser) {
				console.log('ğŸŒ¤ï¸ ä½¿ç”¨å›½å†…å¤©æ°”æº');
				weather = await getQWeather(cityName);
			} else {
				console.log('ğŸŒ¤ï¸ ä½¿ç”¨å›½é™…å¤©æ°”æº');
				weather = await getWttrWeather(cityName);
			}

			// è§£æå¤©æ°”æ•°æ®
			const current = weather.current_condition[0];
			const temp = current.temp_C;
			const desc = current.lang_zh?.[0]?.value || current.weatherDesc[0].value;
			const humidity = current.humidity;
			const windSpeed = current.windspeedKmph;

			// æ›´æ–° UI
			const iconEl = document.getElementById('weather-icon');
			const tempEl = document.getElementById('weather-temp');
			const descEl = document.getElementById('weather-desc');
			const locEl = document.getElementById('weather-location');
			const humidityEl = document.getElementById('weather-humidity');
			const windEl = document.getElementById('weather-wind');

			if (iconEl) iconEl.textContent = getWeatherIcon(desc);
			if (tempEl) tempEl.textContent = `${temp}Â°C`;
			if (descEl) descEl.textContent = desc;
			if (locEl) locEl.textContent = `ğŸ“ ${location.city || location.province}${location.province && location.city ? ', ' + location.province : ''}`;
			if (humidityEl) humidityEl.textContent = `ğŸ’§ ${humidity}%`;
			if (windEl) windEl.textContent = `ğŸŒ¬ï¸ ${windSpeed}km/h`;

			// æ˜¾ç¤ºå†…å®¹
			loading?.classList.add('hidden');
			content?.classList.remove('hidden');

		} catch (err) {
			console.warn('å¤©æ°”è·å–å¤±è´¥:', err);
			loading?.classList.add('hidden');
			error?.classList.remove('hidden');
		}
	}

	// ç»‘å®šé‡è¯•æŒ‰é’®äº‹ä»¶
	function bindRetryButton() {
		const retryBtn = document.getElementById('weather-retry');
		if (retryBtn) {
			retryBtn.onclick = () => {
				const widget = document.getElementById('weather-widget');
				const loading = widget?.querySelector('.weather-loading');
				const error = widget?.querySelector('.weather-error');
				
				// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
				loading?.classList.remove('hidden');
				error?.classList.add('hidden');
				
				// æ¸…é™¤å®šä½ç¼“å­˜ï¼Œé‡æ–°è·å–
				(window as any).__cachedLocation = null;
				initWeather();
			};
		}
	}

	// å»¶è¿ŸåŠ è½½å¤©æ°”ï¼Œç­‰å¾…è®¿å®¢åœ°å›¾å®Œæˆå®šä½åå†è·å–å¤©æ°”
	setTimeout(() => {
		initWeather();
		bindRetryButton();
	}, 3000); // 3ç§’åå¼€å§‹ï¼Œç»™è®¿å®¢åœ°å›¾1.5ç§’çš„å®šä½æ—¶é—´

	// Swup æ”¯æŒ
	document.addEventListener('astro:page-load', () => {
		setTimeout(() => {
			initWeather();
			bindRetryButton();
		}, 3000);
	});
</script>